#!/usr/bin/php
<?php

	/* 
		If $oldDirectory does not exist, then mergeDirectories()
		creates a symbolic link from $oldDirectory to $newDirectory
		
		mergeDirectories() scans the contents of $newDirectory and
		collects all filenames. If a file in $newDirectory does
		not exist in $oldDirectory, then a symbolic is link is
		created in $oldDirectory to the $newDirectory location. 
	*/

	function mergeDirectories($oldDirectory, $newDirectory)
	{
		if (file_exists($oldDirectory) === FALSE) {
			symlink($newDirectory, $oldDirectory);
		} else {
			$newDirectoryContents = scandir($newDirectory);
			
			if (is_array($newDirectoryContents)) {
				foreach ($newDirectoryContents as $filename) {
					if ($filename === '.' || $filename === '..') {
						continue;
					} else {
						$oldDirectoryFilePath = "{$oldDirectory}/{$filename}";
						
						/* If file does not already exist in the old path, create
						a symbolic link from the old path to the new path. */
						if (file_exists($oldDirectoryFilePath) === FALSE) {
							$newDirectoryFilePath = "{$newDirectory}/{$filename}";
							
							symlink($newDirectoryFilePath, $oldDirectoryFilePath);
						}
					} 
				} // foreach
			} // is_arry
		} // is_dir
	} // function
	
	/* Perform migration of Application Scripts folder. */
	$userHomeDirectoryPath = getenv("HOME");
	
	$oldApplicationScriptsPath = "{$userHomeDirectoryPath}/Library/Application Scripts/com.codeux.irc.textual5";
	$newApplicationScriptsPath = "{$userHomeDirectoryPath}/Library/Application Scripts/com.codeux.apps.textual";
	
	if (file_exists($newApplicationScriptsPath) === TRUE) {
		mergeDirectories($oldApplicationScriptsPath, $newApplicationScriptsPath);
	}

	/* Perform migration of Extensions folder. */
	$oldGroupContainerPath = "{$userHomeDirectoryPath}/Library/Group Containers/8482Q6EPL6.com.codeux.irc.textual";
	$newGroupContainerPath = "{$userHomeDirectoryPath}/Library/Group Containers/com.codeux.apps.textual";
	
	$oldTextualExtensionsPath = "{$oldGroupContainerPath}/Library/Application Support/Textual/Extensions";
	$newTextualExtensionsPath = "{$newGroupContainerPath}/Library/Application Support/Textual/Extensions";

	if (file_exists($newTextualExtensionsPath) === TRUE) {
		if (file_exists($oldGroupContainerPath) === FALSE) {
			symlink($newGroupContainerPath, $oldGroupContainerPath);
		} else {
			if (file_exists($oldTextualExtensionsPath) === FALSE) {
				mkdir($oldTextualExtensionsPath, 0700, TRUE); // Recursively create path....
			}
			
			mergeDirectories($oldTextualExtensionsPath, $newTextualExtensionsPath);
		}
	}

	exit(0);
	
?>